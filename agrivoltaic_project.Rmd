---
title:  "Decision analysis of agriphotovoltaic for smallholders in Mali"
author: Annicka Laudenberg, Nils Heidenkamp, Julian Bauer, Michèle Hönicke
output:  
    bookdown::html_document2:
      theme: cerulean
      toc: true
      toc_float: true
      toc_depth: 2
      number_sections: true
      number_figures: true



---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
library(decisionSupport)
library(readr)
library(DiagrammeR)
```
```{asis, add_packages_bib, include=FALSE}
knitr::write_bib(c(.packages(),
                   'decisionSupport', 'DiagrammeR'), 'bib/packages.bib')

bibliography: 
  - bib/references.bib 
  - bib/packages.bib
```


```{asis, echo=FALSE}
Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

For citing: Figure - \@ref(fig:name) , Table - \@ref(tab:name)
```

# **Introduction**





# **Methods**

## Stakeholders

A Stakeholder is "any group or individual who is affected by or can affect the achievement of an organization's objectives" [@Freeman(A stakeholder Approach...)]. Stakeholder management is needed to balance the interests of all stakeholders with regard to their positions. Different stakeholders can have varying influence, depending on their position, to the result of the project outcome. For this project, communication did not take place with all stakeholders, and there was also not enough data to plot all stakeholders in a graph depending on their willingness to cooperate, their interest in the final goal or their influence on the decision maker for example.

The project has local stakeholders as well as those from abroad in the form of development aid organizations. To some extent, also the abroad government, as well as the population of the country and other groups that influence the decisions of the development aid organizations can be counted as stakeholders. At the local level there is the government, which becomes a stakeholder through political guidelines, but also through monetary grants. Many African countries are also striving for development goals, like the "Uganda Vision 2040" idea (@http://www.npa.go.ug/uganda-vision-2040/). The Malian government also has those goals, which include the generation of electricity via solar energy (@https://ideas4development.org/en/malian-agriculture-national-agricultural-development-bank-mali/). Future-oriented projects, like agrivoltaic systems, are therefore interesting for the government.

The projects are executed at farms, and therefore farmers play an important role in the question if those projects will succeed. A close communication between experts and farmers is essential to reduce risks, which could lead otherwise into difficulties. The addition of agrivoltaics aims to benefit not only the smallholder farmers directly, but also the surrounding community. An agrivoltaic system shared by smallholder farmers can lead to a close water access to new parts of rural areas. Other benefits for the community that can come with an agrivoltaic intervention are independent electricity, which can be used from charging mobile devices to cooling dairy products (@owusu-kwarteng) or medication inside a refrigerator (@opiyo). Photovoltaic supply companies play an important role while setting up an agrivoltaic systems. They need to contribute suitable solar panels devices, which can be installed and be maintained with the knowledge of locally available electricians. Those maintenance workers play a key role in the lifespan of those projects. And it is possible that with an increase in the use of solar panels, the number of learned electricians will also increase. An agrivoltaic intervention brings new growing conditions in the shade of the panels and irrigation possibilities with ground water pumps, which can be used to produce crops that would have been previously unable to grow. These new products can influence the local market place, transport processes or even nutrition deficits. More distant stakeholder are nearby communities, anyone who is groundwater dependent or power plant companies, although for stakeholder management these probably do not have to be considered (fig. \@ref(fig:stakeholders)).


```{r stakeholders, echo=FALSE, out.width='90%', fig.align='center', fig.cap="Stakeholder Overview"}
knitr::include_graphics('images/stakeholders.png')
```



## Input Estimates
The estimates are given in ranges with 90% certainty and normally distributed. To produce reliable estimates, calibration is needed. Becoming a calibrated estimator, can be achieved with calibration tests, that help to improve the ability to correctly estimate ranges. The goal is to examine the own tendencies of misjudging and to use the new found knowledge for self-improvement. Constant values in the case of the experiment duration for example are also valid inputs. In combination with the model function, the input estimates are then used to calculate the Monte-Carlo simulation. The estimates were collected with two different methods.

The base of our estimates originates from literature research, which was conducted on experiments and publications with adaptable scenarios to the project. Care was taken to ensure that comparable conditions existed or that the values were interpolated and adapted to our case. For the literature, publications about agrivoltaics mostly in western Africa were of highest interest, but also other literature about photovoltaic and developing aid were considered. Input ranges with the topic of agriculture were estimated with the help of publications like [] .
For the variables regarding the topic of photovoltaic including costs, efficiency and production publications from [Raza et al, Shouman et al] were used. To estimate the ranges about the life and households in western Africa information was gathered in  [The economic lives of smallholder farmers].



```{r inputvariables, caption= "Table with the input variables", echo=FALSE, warning=FALSE}
library(knitr)
input_estimates <- read.csv("data/av_estimates_overview_updated_description.csv", header = TRUE, sep = ";")
input_estimates = subset(input_estimates, select = -c(median))
kable(input_estimates[2:7])
```

## Conceptual Model 
```{r conmodel, out.width='90%', fig.align='center', fig.cap="Conceptual Model", echo=FALSE}
knitr::include_graphics('images/conmodel_1.png')
```

## Questionnaire
After we determined estimates for the input variables based on the literature research, we then decided to create a questionnaire to get more precise values. The idea was to send it to several experts who work on similar projects, have experience with photovoltaic systems or agriculture in Africa, as well as farmers in West Africa who could give us valuable information about current market prices and general agricultural conditions. 

The questionnaire included agricultural related questions (e.g. “Estimate the impact of a severe drought on the yield of millet in [%] on a standard farm.”), technical questions about the photovoltaic system (e.g.''Estimate the potential annual costs for general maintenance of an agrivoltaic system (e.g. repairs, cleaning, preventive maintenance etc.)”) as well as questions related to irrigation (e.g. ”Estimate the potential yield increase in [%] with an irrigation system.”). It was structured so that the participants had to estimate a range for each variable and were able to skip the questions they were not certain about. We contacted a number of experts, but unfortunately not many participants completed the questionnaire.

## Code 
The code generates two Monte Carlo simulation outcomes and is affected by multiple variables from the 'av_estimates' table. One outcome represents a farm with AV intervention and one outcome a reference farm. Further the AV intervention is split into planning, setup and execution parts.
The outcomes are based on a time series analysis for 30 years and 6000 simulations.

### Variability

Some variables vary over the 30 years of simulation. This variation was created with the 'vv' function and the variable 'vv_var' which represents a coefficient of variation. 'vv_var' has a lower and upper bound of 5% and 20%.


### Chance events

Risks were included as chance events with the 'chance_event' function.
Two of those risks were missing input of the population or institutions which would lead to a failure of the project. This would result in planning costs but no benefits through the AV system.

Further risks are 'bad quality of photo voltaic panels' resulting in a lower energy yield than expected, 'bad installation' of the panels and 'bad maintenance' both resulting in higher maintenance costs and 'droughts'. The first three risks reduce the benefits of the AV intervention while 'drought' only has a reducing effect on farms without AV intervention through missing irrigation opportunities.


```{r, echo=T, warning=F}

# data preparation
input_estimates <- read.csv("data/av_estimates_overview.csv", header = TRUE)




model_function <- function(){
  
  
  # ex-ante risks
  av_int_event_no_involvement_by_population <-
    chance_event(av_int_no_involvement_by_population, 1, 0, n = 1)
  av_int_event_no_involvement_by_institution <-
    chance_event(av_int_no_involvement_by_institution, 1, 0, n = 1)
  
  
  
  
  # processing through standard farm and farm with av intervention
  for (decision_av_int in c(FALSE, TRUE))
  {
    
    
    if (decision_av_int)
    {
      decision_av_int_planning <- TRUE
      decision_av_int_setup <- TRUE
      decision_av_int_execution <- TRUE
    }
    
    else
    {
      decision_av_int_planning <- FALSE
      decision_av_int_setup <- FALSE
      decision_av_int_execution <- FALSE
    }
    
    
    
    # if project fails due to no involvement only planning costs remain
    if (av_int_event_no_involvement_by_population)
    {
      decision_av_int_setup <- FALSE
      decision_av_int_execution <- FALSE
    }
    
    if (av_int_event_no_involvement_by_institution)
    {
      decision_av_int_setup <- FALSE
      decision_av_int_execution <- FALSE
    }
    
    
    
    
    
    ### cost calculation
    
    ## calculation planning costs
    if (decision_av_int_planning)
    {
      av_int_planning <- av_int_cost_search_panels + av_int_cost_search_location
    }
    else
    {
      av_int_planning <- 0
    }
    
    
    
    ## calculation of setup costs  
    if (decision_av_int_setup)
    {
      # panel costs
      var_panel_cost = (av_int_cost_photovoltaic_panels * av_ha)
      
      # installation costs and risks
      var_installation_risk_cost = chance_event(chance = av_int_risk_installation,
                                                value_if = vv(av_int_risk_installation_cost, vv_var, n = 1) * 
                                                  av_int_cost_installation, value_if_not = 0, n = 1)
      
      # total setup costs for AV intervention
      av_int_setup <- var_panel_cost +
        av_int_cost_installation +
        var_installation_risk_cost +
        av_int_cost_training
    }
    
    else
    {
      av_int_setup <- 0
    }
    
    
    
    ## calculation execution/maintenance costs   
    if (decision_av_int_execution)
    {
      # cost for repairing the AV facility and maintaining costs through bad maintenance
      av_int_execution <- vv(av_int_cost_reparation, vv_var, n_years) *
        chance_event(chance = av_int_risk_maintenance, 
                     value_if = vv(av_int_risk_maintenance_costs, vv_var, 1), 
                     value_if_not = 1, n = n_years)
    }
    else
    {
      av_int_execution <- 0
    }
    
    
    
    ## calculation of labor costs
    if (decision_av_int_execution)
    {
      # labor costs reduction through AV intervention
      var_labour_reduction <- vv(av_int_labour_reduction, vv_var, n_years)
    }
    
    else
    {
      # if no AV intervention labor intensity stays at 100%
      var_labour_reduction <- vv(c(1, 1), c(0, 0), n_years)
    }
    
    # total labor costs
    var_labour_costs <- var_labour_reduction * 
      vv(av_crop_ha, c(0, 0), n_years) *
      vv(annual_labour, vv_var, n_years) *
      vv(labour_costs, vv_var, n_years)
    
    
    
    ## calculating total costs
    
    # for all years
    av_int_cost <- av_int_execution  + var_labour_costs
    
    # additionally for the first year due to setup and planning costs
    av_int_cost[1] <- av_int_cost[1] + av_int_setup + av_int_planning
    
    
    
    
    ### benefit calculations
    
    
    
    ## calculating energy yield
    
    # risk of low quality panels
    var_lowpanelquality_risk_reduction = chance_event(chance = av_int_risk_panellowquality, 
                                                      value_if = vv(av_int_risk_panellowquality_reduction, 
                                                                    vv_var, n = 1, 
                                                                    upper_limit = 1), 
                                                      value_if_not = 1, n = 1)
    
    # total energy yield
    av_energy_yield <-  vv(av_ha, c(0, 0), 1) *
      vv(av_energy_yield_kwp_ha, 
         vv_var, 
         n_years, 
         relative_trend = -(panel_performance_reduction * 100)) * var_lowpanelquality_risk_reduction
    
    # total energy consumption from pump
    av_energy_pump <-   vv(av_int_annual_irrigation, vv_var, n_years) *
      vv(av_int_pump_energy, vv_var, n_years) *
      vv(av_crop_ha, c(0, 0), n_years)
    
    # calculating variables if energy demand for irrigation is higher than energy yield
    # this does not have an effect on irrigation yet. Only prevents a negative energy yield
    # which would result in costs for energy 
    if (av_energy_pump > av_energy_yield)
    {
      av_energy_pump <- av_energy_yield
    }
    
    # total energy profit
    var_av_energy_profit <- (av_energy_yield - av_energy_pump) * av_energy_profit_EUR_kwp
    
    
    
    ## calculating crop yield
    
    # calculating factors for yield through irrigation, drought risk and shaded crop yield
    if (decision_av_int_execution)
    {
      var_irrigation_factor <- vv(av_int_irrigation_factor, vv_var, n_years)
      # drought has no effect in the model on the AV farm. Factor stays 1
      var_risk_effectdrought <- vv(c(1, 1), c(0, 0), n_years)
      var_shadedcrop_yield <- vv(av_shadedcrop_yield, vv_var, n_years)
    }
    
    else 
    {
      # reference farm has no irrigation. Factor stays 1
      var_irrigation_factor <- vv(c(1, 1), c(0, 0), n_years)
      var_risk_effectdrought <- chance_event(chance = av_risk_drought, 
                                             value_if = vv(av_effects_drought, vv_var, 1), 
                                             value_if_not = 1, n = n_years)
      # no shaded crops in reference farm
      var_shadedcrop_yield <- vv(c(0, 0), c(0, 0), n_years)
    }
    
    # total crop yield
    av_crop_yield <-  vv(av_crop_ha, c(0, 0), n_years) *
      vv(av_crop_yield_t_ha, vv_var, n_years) *
      vv(av_crop_profit_EUR_t, vv_var, n_years) *
      var_irrigation_factor *
      var_risk_effectdrought +
      var_shadedcrop_yield *
      vv(av_shadedcrop_profit, vv_var, n_years) *
      vv(av_ha, c(0, 0), n_years)
    
    
    
    ## calculating total benefits
    
    if(decision_av_int_execution)
    {
      total_benefits <- av_crop_yield + var_av_energy_profit
    }
    
    else
    {
      total_benefits <- av_crop_yield
    }
    
    
    
    
    ### calculating results (benefits - costs)
    
    
    # for reference farm
    if (!decision_av_int)
    {
      net_benefits <- total_benefits - av_int_cost
      result <- net_benefits
    }
    
    # for AV farm
    if (decision_av_int)
    {
      net_benefits <- total_benefits - av_int_cost+ vv(c(333, 333), c(0, 0), n_years)
      result_int <- net_benefits
    }   
  }
  
  
  # calculating net present value (NPV)
  NPV <- discount(result, discount, calculate_NPV = TRUE)
  NPV_int <- discount(result_int, discount, calculate_NPV = TRUE)
  
  
  
  # Generate the list of outputs from the Monte Carlo simulation
  return(list(NPV = NPV,
              NPV_int = NPV_int,
              NPV_decision = NPV_int - NPV,
              Cashflow_decision = result_int - result))
}


# Run the Monte Carlo simulation using the model function
example_mc_simulation <- mcSimulation(estimate = as.estimate(input_estimates),
                                      model_function = model_function,
                                      numberOfModelRuns = 6000,
                                      functionSyntax = "plainNames")

```


# **Results and Discussion**

## Net Present Value (NPV) distributions

The graph and the boxplot shows the NPV difference of the reference farm to the AV farm. The x-axis represents the outcome distribution, the y-axis the density estimate (affected by the number of simulations in a specific outcome range).

The distribution has two peaks. One at around -5000 and one at around +5000 but with a lower density estimate. Both the median and the lower quartile is in a negative range shown by the boxplot.


```{r, echo=F, fig.align='center', fig.cap="Difference in NPV between Intervention and no Intervention"}
plot_distributions(mcSimulation_object = example_mc_simulation, 
                   vars = "NPV_decision",
                   method = 'boxplot_density')
```
<br>
As there is no external investment included in the model at this point the distribution shows probabilities of monetary costs and benefits of an AV intervention. If e.g. a fixed investment of 10000 is assumed for each simulation the curve would be mostly in a positive outcome distribution. This investment would be the the cost for an institution to achieve all the non-monetary benefits (reference to benefits mentioned in other parts of report) while it would have no negative monetary impacts in most cases anymore for the operators of the AV facility. As the AV facility would be operated for around 30 years an investment of 10000 would mean costs of around 330 for supporting infrastructure, communities and food production mentioned in the sustainable development goals (SDG)[https://www.bmz.de/de/agenda-2030]. Further it could enable other opportunities as a higher income for farmers could lead to economic growth.

## EVPI, VIP, Cashflow

The expected value of perfect information (EVPI) is an estimation of the monetary value for any additional information that reduces uncertainty for specific variables in the model. It was calculated to identify the variables for which further information could be beneficial in order to increase certainty of the decision.

In our results the EVPI values were either at zero or very low for all the variables (> 200 USD, fig. \@ref(fig:EVPI)). However, since the result of the NPV is also low, even very low values of the EVPI should be considered as they can have an impact on the outcome.
The highest EVPI was calculated for the yield of millet and the irrigation factor. Irrigation of millet influences the final yield and therefore both variables are crucial for the revenues of the farmer. Gathering additional information about these factors could help to increase certainty about the millet yield, thus the NPV. It is recommended to further investigate the variables with an EVPI above 150 USD to make a better decision.
```{r EVPI, echo=FALSE, out.width='90%', fig.align='center', fig.cap="The EVPI is the estimated amount of money to gain perfect information about a given variable"}
knitr::include_graphics('images/EVPI.png')
```
<br>
<br>
With the PLS analysis the variable importance in projection (VIP) can be calculated. The VIP scores represent the sensitivity of the model on each variable.

In fig. \@ref(fig:VIP) the important variables (VIP > 1) are shown. Variables can either be negatively correlated with the decision outcome (red bars) or there is a positive correlation between the variable and the outcome (blue bars). Our results indicate that the yield of millet and the irrigation factor (Increased yield [%], fig.\@ref(fig:VIP)) are the most important variables for the projection, with an VIP above 3. High yields and an improved yield through irrigation increase the NPV accordingly. The decision output is equally sensitive to all the costs of the intervention, particularly the annual costs of repairs (VIP > 2) have a negative effect on the NPV. The amount of the annual costs are also dependent on the level of maintenance. Poor maintenance increases the costs and thus negatively affects the decision outcome.

```{r VIP, echo=FALSE, out.width='90%', fig.align='center', fig.cap="VIP Scores, indicating the importance of each variable in the model (Threshold of the VIP = 1)", fig.show='hold'}
knitr::include_graphics('images/VIP.png')
```
<br>
The figure \@ref(fig:Cash) shows the annual cashflow over the whole period of the simulation. In our model the cashflow is rather low, likely due to the low estimations for revenues of the additional crop, which is grown under the photovoltaic modules. Overall the returns are steady but just above the zero mark for each year, and only a small chance (5% quantile) for a negative cashflow.

```{r Cash, echo=FALSE, out.width='90%', fig.align='center', fig.cap="Annual Cashflow for 40 years"}
knitr::include_graphics('images/Cashflow.png')
```

## Uncertainties and Issues

In our project we identified several uncertainties that could be included in the model. Due to time constraints not all uncertainties were implemented. We also faced other issues which are listed in the following section. 

The first problem we had was the almost non-existent participation in our questionnaire. We decided not to use the answers for our model because they were inconclusive. We assume that the large number of questions resulted in a low participation. For that reason, some ranges of the input variables are merely based on our own estimations.

In our project the photovoltaic system is mainly used to power a water pump for irrigation. But over the rainy season, which occurs around June until September (https://www.worlddata.info/africa/mali/climate.php), when little or no irrigation is required, there will be a surplus of electricity. During this time, the system brings no advantage to the farmer. For such a scenario, the electricity needs a different recipient. This could be a cooling system for post-harvest crops storage, supply of other households and farmers or even electricity sales, if it is connected to the main power grid. But this creates new challenges. Rural areas are usually not connected to the power grid and any additional investment bears new uncertainties.

Furthermore we implemented the risk of bad maintenance. In the case of bad maintained modules, the farmer will have additional annual costs. However, in our model it does not affect the lifetime nor the PV yield of the modules. But since there is a risk that bad maintenance facilitates the degradation, thus the lifetime and the annual energy yield (DOI: 10.1109/JPHOTOV.2014.2330495,https://doi.org/10.1016/j.solener.2013.07.017, https://doi.org/10.1007/s11356-019-06100-2) (also the EVPI and VIP were high, meaning this variable is important to the decision), adding it to the model should be considered. In addition, there are other uncertainties that should be taken into account as they may affect the decision outcome. Uncertainties such as political instability within the country, outbreak of war and changing conditions due to climate change, which can have a greater impact on the standard of living in less developed countries and the agricultural value chain. But implementing these factors in our model is challenging, because it is unclear how they correlate with the input variables and due to a lack of accurate estimates of their impact on the other factors. 

# **Conclusion**


